{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>{{ ride.title or ('Jízda #' ~ ride.id) }}</h2>
  <div class="grid2">
    <div><div class="muted">Datum</div><div><b>{{ ride.ride_date }}</b></div></div>
    <div><div class="muted">Kůň</div><div><b>{{ horse.name if horse else '—' }}</b></div></div>
    <div><div class="muted">Vzdálenost</div><div><b>{{ '%.2f' % ride.distance_km }} km</b></div></div>
    <div><a href="/gpx/{{ ride.id }}">Stáhnout GPX</a></div>
  </div>
</section>

{% if missing_gpx %}
<section class="card"><div class="alert">⚠️ GPX k této jízdě není k dispozici.</div></section>
{% else %}
<section class="grid-2">
  <div class="card">
    <h3>Mapa (barva = rychlost)</h3>
    <div id="gmap"></div>
    <div class="legend muted">
      <span class="chip" style="background:#3bbb3b"></span>0–10
      <span class="chip" style="background:#9ad34b"></span>10–20
      <span class="chip" style="background:#ffcc00"></span>20–30
      <span class="chip" style="background:#ff6f3c"></span>30–35
      <span class="chip" style="background:#c82333"></span>35+ km/h
    </div>
  </div>
  <div class="card">
    <h3>Rychlost</h3>
    <div id="g_avg" style="height:140px"></div>
    <div id="g_max" style="height:140px"></div>
    <div class="muted">Prahy: {{ walk_trot }} / {{ trot_canter }} km/h</div>
    <div style="margin-top:10px">
      <div>Chůze</div><div class="bar-track"><div class="bar-fill walk" style="width: {{ gait.walk.pct }}%"></div></div>
      <div class="muted">{{ '%.2f' % gait.walk.km }} km – {{ gait.walk.pct|round(0)|int }}%</div>
      <div>Klus</div><div class="bar-track"><div class="bar-fill trot" style="width: {{ gait.trot.pct }}%"></div></div>
      <div class="muted">{{ '%.2f' % gait.trot.km }} km – {{ gait.trot.pct|round(0)|int }}%</div>
      <div>Cval</div><div class="bar-track"><div class="bar-fill canter" style="width: {{ gait.canter.pct }}%"></div></div>
      <div class="muted">{{ '%.2f' % gait.canter.km }} km – {{ gait.canter.pct|round(0)|int }}%</div>
    </div>
  </div>
</section>

<section class="grid-2">
  <div class="card">
    <h3>Rychlost v čase</h3>
    <div id="chart_speed"></div>
  </div>
  <div class="card">
    <h3>Profil trati</h3>
    <div id="chart_elev"></div>
  </div>
</section>

<script>
const avgKmh = {{ ride.avg_speed_kmh or 0 }};
const maxKmh = {{ ride.max_speed_kmh or 0 }};
const coords = {{ coords_json | safe }};
const segs   = {{ segments_json | safe }};
const speed  = {{ speed_json | safe }};
const elev   = {{ elev_json | safe }};

function gauge(id, value, title){
  Plotly.newPlot(id, [{
    type:'indicator', mode:'gauge+number', value:value,
    gauge:{axis:{range:[0, Math.max(30, Math.ceil((value||0)*1.2))]}, bar:{color:'#2d7ef7'}},
    number:{suffix:' km/h', font:{size:26}}, title:{text:title, font:{size:14}}
  }], {margin:{t:10,b:0,l:10,r:10}, height:140, displayModeBar:false});
}
gauge('g_avg', avgKmh, 'Průměrná rychlost');
gauge('g_max', maxKmh, 'Maximální rychlost');

const map = L.map('gmap'); 
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
if (coords.length){
  const b = L.polyline(coords.map(c=>[c[0],c[1]]), {weight:0}).addTo(map).getBounds();
  map.fitBounds(b);
}
function col(v){ if(v>=35) return '#c82333'; if(v>=30) return '#ff6f3c'; if(v>=20) return '#ffcc00'; if(v>=10) return '#9ad34b'; return '#3bbb3b'; }
for (const s of segs){ L.polyline([[s.lat1,s.lon1],[s.lat2,s.lon2]], {color:col(s.v), weight:5, opacity:.9}).addTo(map); }

Plotly.newPlot('chart_speed', [{x: speed.map(p=>p.t), y: speed.map(p=>p.v), type:'scatter', mode:'lines'}], {margin:{t:30}, title:'Rychlost (km/h)', displayModeBar:false});
Plotly.newPlot('chart_elev', [{x: elev.map(p=>p.d), y: elev.map(p=>p.e), type:'scatter', mode:'lines'}], {margin:{t:30}, title:'Výškový profil (km / m)', displayModeBar:false});
</script>
{% endif %}
{% endblock %}
