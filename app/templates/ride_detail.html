{% extends "base.html" %}
{% block content %}
<div class="ride-detail">
  <h2>üìä Detail j√≠zdy</h2>

  <div class="stats-grid">
    <div class="card">
      <h3>Celkov√° doba trv√°n√≠</h3>
      <p>{{ total_time }}</p>
    </div>
    <div class="card">
      <h3>Celkov√° vzd√°lenost</h3>
      <p>{{ total_distance_km }} km</p>
    </div>
  </div>

  <div class="card gauges">
    <h3>Rychlost</h3>
    <div class="gauge-container">
      <div class="gauge">
        <canvas id="avgSpeedGauge"></canvas>
        <p>Pr≈Ømƒõrn√° rychlost<br>{{ avg_speed }} km/h</p>
      </div>
      <div class="gauge">
        <canvas id="maxSpeedGauge"></canvas>
        <p>Maxim√°ln√≠ rychlost<br>{{ max_speed }} km/h</p>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Vzd√°lenost podle chodu</h3>
    <div class="bar-group">
      <p>Ch≈Øze <span>{{ walk_km }} km ‚Äì {{ walk_pct }}%</span></p>
      <div class="bar"><div class="bar-inner walk" style="width: {{ walk_pct }}%"></div></div>
      <p>Klus <span>{{ trot_km }} km ‚Äì {{ trot_pct }}%</span></p>
      <div class="bar"><div class="bar-inner trot" style="width: {{ trot_pct }}%"></div></div>
      <p>Cval <span>{{ canter_km }} km ‚Äì {{ canter_pct }}%</span></p>
      <div class="bar"><div class="bar-inner canter" style="width: {{ canter_pct }}%"></div></div>
    </div>
  </div>

  <div class="card">
    <h3>Anal√Ωza sklonu</h3>
    <div class="bar-group">
      <p>Rovina <span>{{ flat_km }} km ‚Äì {{ flat_pct }}%</span></p>
      <div class="bar"><div class="bar-inner flat" style="width: {{ flat_pct }}%"></div></div>
      <p>Do kopce <span>{{ uphill_km }} km ‚Äì {{ uphill_pct }}%</span></p>
      <div class="bar"><div class="bar-inner uphill" style="width: {{ uphill_pct }}%"></div></div>
      <p>Z kopce <span>{{ downhill_km }} km ‚Äì {{ downhill_pct }}%</span></p>
      <div class="bar"><div class="bar-inner downhill" style="width: {{ downhill_pct }}%"></div></div>
    </div>
  </div>

  <div class="card">
    <h3>Mapa trasy</h3>
    <div id="map" style="height:400px;"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<script>
  // Leaflet mapa
  var map = L.map('map').setView([{{ center_lat }}, {{ center_lon }}], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  var coords = {{ coords|safe }};
  var speeds = {{ speeds|safe }};
  var segments = [];
  for (var i=1; i<coords.length; i++) {
    var speed = speeds[i] || 0;
    var color = speed < {{ walk_trot_kmh }} ? 'green' : 
                (speed < {{ trot_canter_kmh }} ? 'orange' : 'red');
    segments.push(L.polyline([coords[i-1], coords[i]], {color: color, weight: 4}).addTo(map));
  }

  // Gauge charts
  function renderGauge(id, value, max, color) {
    new Chart(document.getElementById(id), {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [value, max-value],
          backgroundColor: [color, '#eee'],
          borderWidth: 0
        }]
      },
      options: {circumference: 180, rotation: 270, cutout: '70%', plugins: {legend:{display:false}}}
    });
  }
  renderGauge('avgSpeedGauge', {{ avg_speed }}, 30, 'green');
  renderGauge('maxSpeedGauge', {{ max_speed }}, 40, 'orange');
</script>
{% endblock %}
