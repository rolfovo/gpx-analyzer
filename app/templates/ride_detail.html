{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>{{ ride.title or 'J√≠zda #' ~ ride.id }}</h2>
  <p>{% if horse %}K≈Ø≈à: <a href="/horse/{{ horse.id }}">{{ horse.name }}</a>{% endif %}</p>
  <ul class="kv">
    <li><span>Datum</span><strong>{{ ride.ride_date }}</strong></li>
    <li><span>Vzd√°lenost</span><strong>{{ '%.2f' % ride.distance_km }} km</strong></li>
    <li><span>√ò rychlost</span><strong>{{ '%.2f' % ride.avg_speed_kmh }} km/h</strong></li>
    <li><span>Max rychlost</span><strong>{{ '%.2f' % ride.max_speed_kmh }} km/h</strong></li>
  </ul>
  <div style="margin-top:8px;display:flex;gap:8px;">
    <a class="button" href="/gpx/{{ ride.id }}">St√°hnout GPX</a>
    <form action="/ride/{{ ride.id }}/delete" method="post"
          onsubmit="return confirm('Opravdu smazat tuto j√≠zdu?')">
      <button class="button danger" type="submit">üóë Smazat j√≠zdu</button>
    </form>
  </div>
</section>

{% if missing_gpx %}
<section class="card">
  <div class="alert">‚ö†Ô∏è GPX soubor k t√©to j√≠zdƒõ nen√≠ k dispozici. Nahrajte jej znovu, aby ≈°ly zobrazit mapa a grafy.</div>
</section>
{% else %}
<section class="card">
  <h3>Mapa</h3>
  <div id="map" style="height:400px;"></div>
</section>

<section class="card">
  <h3>Grafy</h3>
  <div id="chart_speed"></div>
  <div id="chart_elev"></div>
</section>

<script>
const coords = {{ coords | tojson }};
const speed = {{ speed_ts | tojson }};
const elev = {{ elev_profile | tojson }};

const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '&copy; OSM'}).addTo(map);
if (coords.length){
  const latlngs = coords.map(c => [c[0], c[1]]);
  const line = L.polyline(latlngs, {weight:4}).addTo(map);
  map.fitBounds(line.getBounds());
}

Plotly.newPlot('chart_speed',[{x: speed.map(p=>p.t), y: speed.map(p=>p.v), type:'scatter', mode:'lines'}],
  {title:'Rychlost v ƒçase (km/h)', margin:{t:30}});
Plotly.newPlot('chart_elev',[{x: elev.map(p=>p.d), y: elev.map(p=>p.e), type:'scatter', mode:'lines'}],
  {title:'Profil trati (km / m)', xaxis:{title:'Km'}, yaxis:{title:'m n. m.'}, margin:{t:30}});
</script>
{% endif %}
{% endblock %}
