{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>{{ ride.title or 'Jízda #' ~ ride.id }}</h2>
  <div class="grid-2">
    <div>
      <ul class="kv">
        <li><span>Datum</span><strong>{{ ride.ride_date }}</strong></li>
        <li><span>Vzdálenost</span><strong>{{ '%.2f' % ride.distance_km }} km</strong></li>
        <li><span>Čas celkem</span><strong>{{ (ride.total_time_s // 3600) }}h {{ ((ride.total_time_s % 3600)//60) }}m</strong></li>
        <li><span>Čas v pohybu</span><strong>{{ (ride.moving_time_s // 3600) }}h {{ ((ride.moving_time_s % 3600)//60) }}m</strong></li>
        <li><span>Ø rychlost</span><strong id="avg_kmh">{{ '%.2f' % ride.avg_speed_kmh }}</strong> km/h</li>
        <li><span>Max rychlost</span><strong id="max_kmh">{{ '%.2f' % ride.max_speed_kmh }}</strong> km/h</li>
        <li><span>Převýšení</span><strong>↑ {{ '%.0f' % ride.ascent_m }} m / ↓ {{ '%.0f' % ride.descent_m }} m</strong></li>
        <li><span>Nadmořská výška</span><strong>{{ '%.0f' % (ride.min_elev_m or 0) }}–{{ '%.0f' % (ride.max_elev_m or 0) }} m</strong></li>
      </ul>
      <p><a class="button" href="/gpx/{{ ride.id }}">Stáhnout původní GPX</a></p>
      <form action="/ride/{{ ride.id }}/assign" method="post" class="grid">
        <div><label>Přiřadit ke koni</label>
          <input type="text" name="horse_name" list="horse_list" value="{{ ride.horse.name if ride.horse else '' }}" placeholder="např. Orin" required>
          <datalist id="horse_list">{% for h in horses %}<option value="{{ h.name }}">{% endfor %}</datalist>
        </div>
        <div class="row"><button type="submit">Uložit</button></div>
      </form>
    </div>
    <div>
      <div class="gauges">
        <div id="gauge_avg"></div>
        <div id="gauge_max"></div>
      </div>
    </div>
  </div>
</section>

<section class="card">
  <h3>Rychlosti chodů</h3>
  <p class="small">Posuň šoupátka pro hranice <strong>krok/klus</strong> a <strong>klus/cval</strong>. Ukládá se do prohlížeče.</p>
  <div class="gait-controls">
    <div>
      <label>Krok → Klus (km/h)</label>
      <input type="number" id="thr_walk_trot" step="0.1" value="7.0">
    </div>
    <div>
      <label>Klus → Cval (km/h)</label>
      <input type="number" id="thr_trot_canter" step="0.1" value="13.0">
    </div>
    <button id="apply_gaits">Přepočítat</button>
  </div>
  <div id="gait-bars"></div>
</section>

<section class="card">
  <h3>Analýza sklonu</h3>
  <p class="small">Rovina |grade| &lt; 1 %, Do kopce ≥ 1 %, Z kopce ≤ −1 %.</p>
  <div id="slope-bars"></div>
</section>

<section class="card">
  <h3>Profil převýšení</h3>
  <div id="elev_plot"></div>
</section>

<section class="card">
  <h3>Rychlost v čase</h3>
  <div id="speed_plot"></div>
</section>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const elev = {{ elev_profile | tojson }}; // [{d,e}]
  const speed = {{ speed_ts | tojson }};    // [{t,v}] v in km/h

  // --- Helpers ---
  const km = n => Math.round(n*100)/100;
  function loadThresholds(){
    try {
      const x = JSON.parse(localStorage.getItem('gpx_gait_thresholds') || '{}');
      return { walk_trot: parseFloat(x.walk_trot||'7') || 7, trot_canter: parseFloat(x.trot_canter||'13') || 13 };
    } catch(e){ return { walk_trot:7, trot_canter:13 }; }
  }
  function saveThresholds(obj){ localStorage.setItem('gpx_gait_thresholds', JSON.stringify(obj)); }

  const thr = loadThresholds();
  document.getElementById('thr_walk_trot').value = thr.walk_trot.toFixed(1);
  document.getElementById('thr_trot_canter').value = thr.trot_canter.toFixed(1);

  // --- Gauges ---
  const avg = parseFloat(document.getElementById('avg_kmh').textContent);
  const maxv = parseFloat(document.getElementById('max_kmh').textContent);
  const gmax = Math.max(10, Math.ceil(maxv*1.2));
  Plotly.newPlot('gauge_avg', [{
    type:'indicator', mode:'gauge+number',
    value: avg, title:{text:'Průměrná rychlost'},
    number:{suffix:' km/h'},
    gauge:{axis:{range:[0,gmax]}, steps:[
      {range:[0,thr.walk_trot], color:'rgba(0,150,0,0.3)'},
      {range:[thr.walk_trot,thr.trot_canter], color:'rgba(255,200,0,0.3)'},
      {range:[thr.trot_canter,gmax], color:'rgba(255,0,0,0.25)'}
    ]}
  }], {margin:{t:20,b:10,l:10,r:10}, height:200});

  Plotly.newPlot('gauge_max', [{
    type:'indicator', mode:'gauge+number',
    value: maxv, title:{text:'Maximální rychlost'},
    number:{suffix:' km/h'},
    gauge:{axis:{range:[0,gmax]}, steps:[
      {range:[0,thr.walk_trot], color:'rgba(0,150,0,0.3)'},
      {range:[thr.walk_trot,thr.trot_canter], color:'rgba(255,200,0,0.3)'},
      {range:[thr.trot_canter,gmax], color:'rgba(255,0,0,0.25)'}
    ]}
  }], {margin:{t:20,b:10,l:10,r:10}, height:200});

  // --- Elevation vs distance ---
  Plotly.newPlot('elev_plot', [{
    x: elev.map(p => p.d),
    y: elev.map(p => p.e),
    mode: 'lines', name: 'elev'
  }], { xaxis: { title: 'Vzdálenost (km)' }, yaxis: { title: 'Nadm. výška (m)' }, margin: { t: 10 } });

  // --- Speed vs time ---
  Plotly.newPlot('speed_plot', [{
    x: speed.map(p => p.t),
    y: speed.map(p => p.v),
    mode: 'lines', name: 'speed'
  }], { xaxis: { title: 'Čas' }, yaxis: { title: 'Rychlost (km/h)' }, margin: { t: 10 } });

  // --- Gaits computation ---
  function computeGaits(thrA, thrB){
    let walk_m=0, trot_m=0, canter_m=0;
    for(let i=1;i<speed.length;i++){
      const prev = speed[i-1], cur = speed[i];
      if(!prev.t || !cur.t) continue;
      const dt = (new Date(cur.t) - new Date(prev.t))/1000; // s
      if(dt<=0) continue;
      const v = cur.v; // km/h
      const dist_m = v * 1000/3600 * dt;
      if(v < thrA) walk_m += dist_m;
      else if(v < thrB) trot_m += dist_m;
      else canter_m += dist_m;
    }
    return { walk_km: walk_m/1000, trot_km: trot_m/1000, canter_km: canter_m/1000 };
  }

  function renderBars(containerId, items){
    const cont = document.getElementById(containerId);
    cont.innerHTML = '';
    const total = items.reduce((s,i)=>s+i.km,0);
    items.forEach(it=>{
      const pct = total>0 ? (it.km/total*100) : 0;
      const row = document.createElement('div');
      row.className = 'barrow';
      row.innerHTML = `
        <div class="barlabel">${it.label}</div>
        <div class="barwrap"><div class="bar" style="width:${pct}%; background:${it.color}"></div></div>
        <div class="barval">${km(it.km)} km – ${pct.toFixed(0)}%</div>`;
      cont.appendChild(row);
    });
  }

  function recomputeGaits(){
    const thrA = parseFloat(document.getElementById('thr_walk_trot').value) || 7;
    const thrB = parseFloat(document.getElementById('thr_trot_canter').value) || 13;
    saveThresholds({walk_trot:thrA, trot_canter:thrB});
    const g = computeGaits(thrA, thrB);
    renderBars('gait-bars', [
      {label:'Chůze', km:g.walk_km, color:'linear-gradient(90deg,#4caf50,#7ddc6f)'},
      {label:'Klus',  km:g.trot_km, color:'linear-gradient(90deg,#ffd54f,#ffc107)'},
      {label:'Cval',  km:g.canter_km, color:'linear-gradient(90deg,#ef5350,#ff7043)'}
    ]);
  }
  document.getElementById('apply_gaits').addEventListener('click', recomputeGaits);
  recomputeGaits();

  // --- Slope analysis ---
  function computeSlope(){
    const thr = 0.01; // 1%
    let flat_km=0, up_km=0, down_km=0;
    for(let i=1;i<elev.length;i++){
      const a = elev[i-1], b = elev[i];
      const dd_km = b.d - a.d;
      if(dd_km <= 0) continue;
      const de_m = b.e - a.e;
      const grade = de_m / (dd_km*1000);
      if(Math.abs(grade) < thr) flat_km += dd_km;
      else if(grade > 0) up_km += dd_km;
      else down_km += dd_km;
    }
    return {flat_km, up_km, down_km};
  }
  function renderSlope(){
    const s = computeSlope();
    const items = [
      {label:'Rovina', km:s.flat_km, color:'linear-gradient(90deg,#66bdb7,#8fd3c8)'},
      {label:'Do kopce', km:s.up_km, color:'linear-gradient(90deg,#4db6ac,#26a69a)'},
      {label:'Z kopce', km:s.down_km, color:'linear-gradient(90deg,#80cbc4,#4db6ac)'}
    ];
    renderBars('slope-bars', items);
  }
  renderSlope();
</script>
